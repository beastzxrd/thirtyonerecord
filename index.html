<script>
// Detectar si la app ya está instalada (modo standalone)
const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true;

if (isInstalled) {
  console.log('[PWA] App ya instalada - Redirigiendo al sitio...');
  // Redirigir automáticamente al sitio principal
  window.location.href = 'https://www.thirtyonerecord.com';
}

const statusEl = document.getElementById('status');
const installBtn = document.getElementById('installBtn');
let deferredPrompt = null;

function openSite() {
  window.open('https://www.thirtyonerecord.com', '_blank');
}

async function installApp() {
  statusEl.textContent = 'Intentando instalar...';
  
  if (!deferredPrompt) {
    statusEl.textContent = 'App ya instalada o no disponible para instalar';
    return;
  }

  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    console.log('[PWA] Instalación aceptada');
    statusEl.textContent = '✓ App instalada en tu dispositivo';
  } else {
    statusEl.textContent = 'Instalación cancelada';
  }
  
  deferredPrompt = null;
}

window.addEventListener('beforeinstallprompt', (e) => {
  console.log('[PWA] beforeinstallprompt disparado');
  e.preventDefault();
  deferredPrompt = e;
  statusEl.textContent = '✓ App lista para instalar';
});

window.addEventListener('appinstalled', () => {
  console.log('[PWA] App instalada correctamente');
  statusEl.textContent = '✓ App instalada en tu dispositivo';
  deferredPrompt = null;
});

// Service Worker Registration
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js', { scope: '/' })
    .then(registration => {
      console.log('[PWA] SW registrado:', registration.scope);
      statusEl.textContent = 'Service Worker: ✓';
    })
    .catch(error => {
      console.error('[PWA] Error SW:', error);
      statusEl.textContent = 'Error: ' + error.message;
    });
} else {
  statusEl.textContent = 'Service Worker no soportado';
}
</script>
